#!/usr/bin/env python

import argparse
import sys
import os.path
import hashlib
from Crypto.Cipher import AES
from Crypto import Random
import json
import re

HARDCODED_STRING = "e6f5bfbaae81a4496b5489f"
GALLERY_LOCATION = -1
OUT_OF_GALLERY_LOCATION = -2

def handle_options(options, log_data=None):
    if log_data:
        data = json.loads(log_data)
        timestamp = data['t']
        if timestamp >= options.timestamp:
            # timestamps need to increase
            return -1
        data['t'] = options.timestamp

        if options.guest_name:
            database = data['g']
            name = options.guest_name
        else:
            database = data['e']
            name = options.employee_name


        if options.departure:
            if not name in database:
                # no data on user
                # a user not in our system can't leave
                return -1
            if options.room_id:
                if database[name]['s'] == options.room_id:
                    # sucessfully left the room
                    # set status
                    database[name]['s'] = GALLERY_LOCATION
                    # show when that room was left
                    database[name][str(options.room_id)].append(options.timestamp)
                else:
                    # can't leave a room not currently in
                    return -1
            else:
                if database[name]['s'] == GALLERY_LOCATION:
                    # successfully left the gallery
                    # set status
                    database[name]['s'] = OUT_OF_GALLERY_LOCATION
                    # show when gallery was left
                    database[name]['ga'].append(options.timestamp)
                else:
                    # either in a room or not in gallery, can't leave it
                    return -1
        else:
            # this is an arrival
            if not name in database:
                # no data on user
                if options.room_id:
                    # can't enter a room first
                    return -1
                else:
                    # successfully entered gallery for first time
                    database[name] = {'s': GALLERY_LOCATION, 'ga': [options.timestamp]}
            else:
                if options.room_id:
                    if database[name]['s'] == GALLERY_LOCATION:
                        # successfully entered room
                        # set status
                        database[name]['s'] = options.room_id

                        # show when room was entered
                        if options.room_id in database[name]:
                            # add to list to log when user in room
                            database[name][str(options.room_id)].append(options.timestamp)
                        else:
                            # create new dictionary to log when user in room
                            database[name][str(options.room_id)] = [options.timestamp]
                    else:
                        # user must be in the gallery to enter another room
                        return -1
                else:
                    if database[name]['s'] != OUT_OF_GALLERY_LOCATION:
                        # can't re enter gallery except from outside the gallery
                        return -1
                    else:
                        # sucessfully re entered the gallery
                        database[name]['s'] = GALLERY_LOCATION
                        database[name]['ga'].append(options.timestamp)

    else:
        data = {}
        data['t'] = options.timestamp
        data['g'] = {}
        data['e'] = {}

        if options.departure:
            # this is the first entry, has to be an arrival
            return -1
        if options.room_id:
            # can't enter a room first
            return -1
        if options.guest_name:
            data['g'][options.guest_name] = {'s': GALLERY_LOCATION, 'ga': [options.timestamp]}
        else:
            data['e'][options.employee_name] = {'s': GALLERY_LOCATION, 'ga': [options.timestamp]}

    result = json.dumps(data)
    return result

def encrypt_to_file(file_path, data, options, writeString=False):
    f=open(file_path, 'w')
    nonce = os.urandom(AES.block_size)
    if writeString:
        message = HARDCODED_STRING + data
    else:
        message = str(data)
    # encrypted under the -K option passed in as a 256 hash
    key = hashlib.sha256(options.token).digest()

    obj = AES.new(key, AES.MODE_CFB, nonce)
    ciphertext = obj.encrypt(message)

    # first line of file is unencrypted nonce, 2nd line is encrypted
    # first line of encrypted is the hardcoded string, rest is log data
    f.write(nonce + ciphertext)
    f.close()


def handle_single_command(options):
    log_path = options.log

    if log_path == None:
        # we need the last argument to be the path to log
        return -1

    if options.token == None and re.match('^[\w]+$', options.token) is not None:
        # need to submit a token and be alpha numeric
        return -1

    # TODO
    # verify exactly one emp/guest
    # verify alphabetical of emp/guest
    # verify exactly one of arrive/depart
    # room id is good
    # verify no B option here

    if os.path.isfile(log_path):
        # appending to an existing log
        f=open(log_path, 'r')
        raw = f.read()
        f.close()
        nonce = raw[:AES.block_size]
        ciphertext = raw[AES.block_size:]

        # decrypted under the -K option passed in as a 256 hash
        key = hashlib.sha256(options.token).digest()
        obj = AES.new(key, AES.MODE_CFB, nonce)

        message = obj.decrypt(ciphertext)
        hardcode_attempt = message[:len(HARDCODED_STRING)]
        

        if hardcode_attempt != HARDCODED_STRING:
            # token was not correct if it didn't decrypt
            # to the hardcoded string properly
            return -2

        data = message[len(HARDCODED_STRING):]

        # rest of data is json
        result = handle_options(options, data)
        if result == -1:
            return -1

        # encrypt the json result
        encrypt_to_file(log_path, result, options, writeString=True)
    else:
        # this is a new log
        result = handle_options(options)
        if result == -1:
            return -1
        encrypt_to_file(log_path, result, options, writeString=True)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("-T", type=int, dest="timestamp")
    parser.add_argument("-K", dest="token")
    parser.add_argument("-E", dest="employee_name")
    parser.add_argument("-G", dest="guest_name")
    parser.add_argument("-A", dest="arrival", action='store_true')
    parser.add_argument("-L", dest="departure", action='store_true')
    parser.add_argument("-R", type=int, dest="room_id")
    parser.add_argument("-B", dest="batch", action='store_true')
    parser.add_argument("log", help='string for log path or batch path')

    options = parser.parse_args()

    # TODO handle the -B option

    result = handle_single_command(options)
    if result == -2:
        sys.stderr.write("security error")
        sys.exit(-1)
    if result == -1:
        sys.stdout.write('invalid')
        sys.exit(-1)


if __name__ == "__main__":
    main()

